# zshrc extensions
# This file will be loaded in ~/.zprezto/runcoms/zshrc

# Keychain
if command -v keychain > /dev/null ; then
    SSH_KEYS=($(ls "$HOME/.ssh" | grep "id_" | grep -v "pub"))
    eval "$(keychain --eval --quiet $SSH_KEYS)"
fi

# Aliases
alias -g 'S!'='>& /dev/null &!'
# Useful function to fix ssh agent forwarding
function fixssh() { eval $(tmux show-env -s |grep '^SSH_') }
# Useful function to clear zprezto auto-complete cache
function compcache_clear() {
    rm -rf "${XDG_CACHE_HOME:-$HOME/.cache}/prezto/zcompdump"
}

# Setup dir_colors
[ -s "$HOME/.dir_colors" ] && eval `dircolors $HOME/.dir_colors`

# Load rtx early, so rtx's tools can be used for auto-completion
export RTX_DATA_DIR="$HOME/.local/apps/rtx"
RTX_PATH=$(command -v rtx)
if [[ $? == 0 ]]; then
    eval "$($RTX_PATH activate zsh)"
fi

# Setup Mambaforge
# Adapted from 'conda init' output to use relative path, so as to improve system-compatiblity
export MAMBA_DIR="$HOME/.local/apps/mambaforge"
if [ -d "$MAMBA_DIR" ]; then
    __conda_setup="$("$MAMBA_DIR/bin/conda" 'shell.zsh' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "$MAMBA_DIR/etc/profile.d/conda.sh" ]; then
            source "$MAMBA_DIR/etc/profile.d/conda.sh"
        else
            export PATH="$MAMBA_DIR/bin:$PATH"
        fi
    fi
    unset __conda_setup

    if [ -f "$MAMBA_DIR/etc/profile.d/mamba.sh" ]; then
        source "$MAMBA_DIR/etc/profile.d/mamba.sh"
    fi
fi

# Setup PHPENV
export PHPENV_ROOT="$HOME/.local/apps/phpenv"
if [ -d "${PHPENV_ROOT}" ]; then
    export PATH="${PHPENV_ROOT}/bin:${PATH}"
    eval "$(phpenv init -)"
fi

# Setup completion for terraform
TERRAFORM_PATH=$(command -v terraform)
if [[ $? == 0 ]]; then
    autoload -U +X bashcompinit && bashcompinit
    complete -o nospace -C "$TERRAFORM_PATH" terraform
fi

# Setup completion for pipx
PIPX_PATH=$(command -v pipx)
if [[ $? == 0 ]]; then
    REAL_PIPX_PATH=$(realpath "$PIPX_PATH")
    PIPX_BIN_DIR=$(dirname "$REAL_PIPX_PATH")
    ARG_COMPLETE_BIN="$PIPX_BIN_DIR/register-python-argcomplete"
    if [[ -f "$ARG_COMPLETE_BIN" ]]; then
        eval "$($ARG_COMPLETE_BIN pipx)"
    fi
fi

# Setup completion for kubectl
KUBECTL_PATH=$(command -v kubectl)
if [[ $? == 0 ]]; then
    source <("$KUBECTL_PATH" completion zsh)
fi

# Setup kubeswitch
KUBESWITCH_DIR=$HOME/.local/apps/kubeswitch/current
[ -s "$KUBESWITCH_DIR/switch.sh" ] && source "$KUBESWITCH_DIR/switch.sh"

# Setup zoxide
ZOXIDE_PATH=$(command -v zoxide)
if [[ $? == 0 ]]; then
    eval "$($ZOXIDE_PATH init zsh)"
fi

# Setup direnv
DIRENV_PATH=$(command -v direnv)
if [[ $? == 0 ]]; then
    eval "$($DIRENV_PATH hook zsh)"
fi

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
